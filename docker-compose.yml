services:
  # ============ PROXY - holds all API secrets ============
  proxy:
    build: ./proxy
    container_name: proxy
    restart: unless-stopped
    environment:
      - LOG_RAW=${LOG_RAW:-false}
    networks:
      - agent-net
    secrets:
      - base_url
      - api_key
      - zai_api_key
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:3200/health')"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 5s
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M

  # ============ CORE - Agent + Tools + HTTP API ============
  core:
    build: ./core
    container_name: core
    restart: unless-stopped
    depends_on:
      proxy:
        condition: service_healthy
    environment:
      - PROXY_URL=http://proxy:3200
      - MODEL_NAME=openai/gpt-oss-120b
      - WORKSPACE=/workspace
      - WORKSPACE_HOST_PATH=${PWD}/workspace
      - EXPOSED_PORTS=5000-5099
      - AGENT_CWD=/workspace
      - API_PORT=4000
      - BOT_URL=http://bot:4001
      - USERBOT_URL=http://userbot:8080
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    secrets:
      - gdrive_client_id
      - gdrive_client_secret
    volumes:
      - ./workspace:/workspace
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - agent-net
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - SETUID
      - SETGID
      - NET_BIND_SERVICE
    security_opt:
      - no-new-privileges:true
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
          pids: 300
        reservations:
          cpus: '0.5'
          memory: 512M
    tmpfs:
      - /tmp:size=100M,mode=1777
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s

  # ============ BOT - Telegram Bot (Telegraf) ============
  bot:
    build: ./bot
    container_name: bot
    restart: unless-stopped
    depends_on:
      core:
        condition: service_healthy
    environment:
      - CORE_URL=http://core:4000
      - PROXY_URL=http://proxy:3200
      - MODEL_NAME=openai/gpt-oss-120b
      - BOT_PORT=4001
      - MAX_CONCURRENT_USERS=10
      - ADMIN_USER_ID=${ADMIN_USER_ID:-809532582}
    secrets:
      - telegram_token
    networks:
      - agent-net
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ============ USERBOT - Telethon agent ============
  userbot:
    build: ./userbot
    container_name: userbot
    restart: unless-stopped
    profiles:
      - userbot
    depends_on:
      core:
        condition: service_healthy
    environment:
      - CORE_URL=http://core:4000
      - RESPONSE_CHANCE_DM=1.0
      - RESPONSE_CHANCE_GROUP=0.1
      - RESPONSE_CHANCE_MENTION=1.0
      - RESPONSE_CHANCE_REPLY=1.0
      - COOLDOWN_SECONDS=0
      - OWNER_ID=${OWNER_ID:-809532582,65341407}
      - OWNER_ONLY=true
    secrets:
      - telegram_api_id
      - telegram_api_hash
      - telegram_phone
    volumes:
      - ./userbot/session:/app/session
    networks:
      - agent-net
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M

# ============ SECRETS ============
secrets:
  telegram_token:
    file: ./secrets/telegram_token.txt
  base_url:
    file: ./secrets/base_url.txt
  api_key:
    file: ./secrets/api_key.txt
  zai_api_key:
    file: ./secrets/zai_api_key.txt
  gdrive_client_id:
    file: ./secrets/gdrive_client_id.txt
  gdrive_client_secret:
    file: ./secrets/gdrive_client_secret.txt
  telegram_api_id:
    file: ./secrets/telegram_api_id.txt
  telegram_api_hash:
    file: ./secrets/telegram_api_hash.txt
  telegram_phone:
    file: ./secrets/telegram_phone.txt

networks:
  agent-net:
    driver: bridge
    internal: false
