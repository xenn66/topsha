services:
  # ============ PROXY - holds all API secrets ============
  proxy:
    build: ./proxy
    container_name: proxy
    restart: unless-stopped
    networks:
      - agent-net
    secrets:
      - source: base_url
        mode: 0444
      - source: api_key
        mode: 0444
      - source: zai_api_key
        mode: 0444
    healthcheck:
      test: ["CMD", "node", "-e", "fetch('http://localhost:3200/health').then(r => process.exit(r.ok ? 0 : 1)).catch(() => process.exit(1))"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 5s
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M

  # ============ GATEWAY - Telegram bot + Agent ============
  gateway:
    build: .
    container_name: gateway
    restart: unless-stopped
    depends_on:
      proxy:
        condition: service_healthy
    environment:
      # NO API KEYS HERE! Only proxy URL
      - PROXY_URL=http://proxy:3200
      - MODEL_NAME=openai/gpt-oss-120b
      - MCP_PORT=3100
      - MCP_URL=http://localhost:3100
      - WORKSPACE=/workspace
      - EXPOSED_PORTS=5000-5099
      - MAX_CONCURRENT_USERS=10
      - AGENT_CWD=/workspace
    secrets:
      - source: telegram_token
        mode: 0444
      - source: gdrive_client_id
        mode: 0444
      - source: gdrive_client_secret
        mode: 0444
    volumes:
      - ./workspace:/workspace
      - /var/run/docker.sock:/var/run/docker.sock:ro  # Docker API for sandboxing
    # Ports 5000-5099 are used by sandbox containers (created dynamically)
    # No ports needed on gateway itself
    networks:
      - agent-net
    
    # ============ SECURITY HARDENING ============
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - SETUID
      - SETGID
      - NET_BIND_SERVICE
    security_opt:
      - no-new-privileges:true
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
          pids: 300
        reservations:
          cpus: '0.5'
          memory: 512M
    tmpfs:
      - /tmp:size=100M,mode=1777
    healthcheck:
      test: ["CMD", "node", "-e", "console.log('ok')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

# ============ SECRETS ============
secrets:
  telegram_token:
    file: ./secrets/telegram_token.txt
  base_url:
    file: ./secrets/base_url.txt
  api_key:
    file: ./secrets/api_key.txt
  zai_api_key:
    file: ./secrets/zai_api_key.txt
  gdrive_client_id:
    file: ./secrets/gdrive_client_id.txt
  gdrive_client_secret:
    file: ./secrets/gdrive_client_secret.txt

networks:
  agent-net:
    driver: bridge
    internal: false
